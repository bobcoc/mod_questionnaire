# Moodle问卷插件添加星级评分题型 - 快速实施指南

## 简介

本指南帮助您在Moodle的问卷(questionnaire)插件中添加类似淘宝的星级评分题型。

## 已创建的文件

✅ 以下文件已经创建好,无需手动创建:

1. `mod/questionnaire/classes/question/starrating.php` - 星级评分题型核心类
2. `mod/questionnaire/templates/question_starrating.mustache` - 问题显示模板
3. `mod/questionnaire/templates/response_starrating.mustache` - 答案显示模板  
4. `mod/questionnaire/styles_starrating.css` - 样式文件
5. `mod/questionnaire/javascript/starrating.js` - JavaScript交互脚本
6. `mod/questionnaire/STARRATING_IMPLEMENTATION_GUIDE.md` - 详细英文指南

## 需要手动修改的文件

### 1. 修改 `classes/question/question.php`

在第42行左右,添加新的题型常量定义:

```php
define('QUESSLIDER', 11);
define('QUESSTARRATING', 12);  // ← 添加这一行
define('QUESPAGEBREAK', 99);
```

在第117行左右的 `$qtypenames` 数组中添加:

```php
private static $qtypenames = [
    QUESYESNO => 'yesno',
    QUESTEXT => 'text',
    QUESESSAY => 'essay',
    QUESRADIO => 'radio',
    QUESCHECK => 'check',
    QUESDROP => 'drop',
    QUESRATE => 'rate',
    QUESDATE => 'date',
    QUESNUMERIC => 'numerical',
    QUESPAGEBREAK => 'pagebreak',
    QUESSECTIONTEXT => 'sectiontext',
    QUESSLIDER => 'slider',
    QUESSTARRATING => 'starrating',  // ← 添加这一行
];
```

### 2. 修改 `locallib.php`

在 `questionnaire_get_type()` 函数中(约478行),添加新的case:

```php
function questionnaire_get_type ($id) {
    switch ($id) {
        case 1:
            return get_string('yesno', 'questionnaire');
        // ... 其他case ...
        case 11:
            return get_string('slider', 'questionnaire');
        case 12:  // ← 添加这3行
            return get_string('starrating', 'questionnaire');
        case 100:
            return get_string('sectiontext', 'questionnaire');
        // ... 后续代码 ...
    }
}
```

### 3. 修改语言文件 `lang/en/questionnaire.php`

在文件末尾添加:

```php
$string['starrating'] = 'Star Rating';
$string['starrating_help'] = 'Display a star rating question where users can rate items using stars (like Taobao rating system).';
$string['starrating_link'] = 'mod/questionnaire/questions#Star_Rating';
$string['maxstars'] = 'Maximum number of stars';
$string['maxstars_help'] = 'Select the maximum number of stars to display (3-10 stars). Default is 5 stars.';
```

### 4. (可选)创建中文语言文件 `lang/zh_cn/questionnaire.php`

如果需要中文支持,创建或修改此文件:

```php
<?php
$string['starrating'] = '星级评分';
$string['starrating_help'] = '显示星级评分问题,用户可以使用星星对项目进行评分(类似淘宝评分系统)。';
$string['starrating_link'] = 'mod/questionnaire/questions#Star_Rating';
$string['maxstars'] = '最多星数';
$string['maxstars_help'] = '选择要显示的最大星数(3-10颗星)。默认为5颗星。';
```

### 5. 修改 `db/install.php`

在安装函数中添加题型记录:

```php
function xmldb_questionnaire_install() {
    global $DB;
    
    // 在现有代码后添加
    $DB->insert_record('questionnaire_question_type', [
        'typeid' => 12,
        'type' => 'Star Rating',
        'has_choices' => 'y',
        'response_table' => 'response_rank'
    ]);
    
    return true;
}
```

如果插件已安装,可以手动在数据库执行:

```sql
INSERT INTO mdl_questionnaire_question_type (typeid, type, has_choices, response_table) 
VALUES (12, 'Star Rating', 'y', 'response_rank');
```

### 6. 修改 `tests/behat/behat_mod_questionnaire.php`

在约109行的 `$validtypes` 数组中添加:

```php
$validtypes = array(
    '----- Page Break -----',
    'Check Boxes',
    'Date',
    'Dropdown Box',
    'Essay Box',
    'Label',
    'Numeric',
    'Radio Buttons',
    'Rate (scale 1..5)',
    'Text Box',
    'Yes/No',
    'Slider',
    'Star Rating');  // ← 添加这一行
```

## 实施步骤

1. **备份数据**
   - 备份数据库
   - 备份代码文件

2. **应用修改**
   - 按照上述说明修改6个文件
   - 确保所有创建的文件都在正确位置

3. **更新数据库**
   - 在数据库中添加题型记录(步骤5)
   - 或升级插件版本触发安装脚本

4. **清除缓存**
   ```bash
   # 方式1: 通过管理界面
   网站管理 > 开发 > 清除所有缓存
   
   # 方式2: 通过命令行
   php admin/cli/purge_caches.php
   ```

5. **测试功能**
   - 创建一个测试问卷
   - 添加星级评分题目
   - 填写并提交问卷
   - 查看答案统计

## 使用示例

创建星级评分题目:

1. 进入问卷编辑页面
2. 点击"添加问题"
3. 选择"Star Rating"
4. 填写配置:
   - **问题名称**: Q1
   - **问题文本**: 请对以下服务进行评分
   - **最多星数**: 5
   - **可能的答案**(每行一个):
     ```
     商品质量
     物流速度  
     客服态度
     整体满意度
     ```
5. 保存

## 效果预览

用户看到的界面:

```
请对以下服务进行评分 *

商品质量
☆☆☆☆☆ (0/5)

物流速度
☆☆☆☆☆ (0/5)

客服态度
☆☆☆☆☆ (0/5)

整体满意度
☆☆☆☆☆ (0/5)
```

点击星星后:

```
商品质量
★★★★☆ (4/5)
```

## 文件对照表

| 序号 | 文件路径 | 状态 | 说明 |
|------|---------|------|------|
| 1 | `classes/question/starrating.php` | ✅ 已创建 | 题型核心类 |
| 2 | `classes/question/question.php` | ⏳ 需修改 | 添加常量定义 |
| 3 | `locallib.php` | ⏳ 需修改 | 添加类型名称 |
| 4 | `lang/en/questionnaire.php` | ⏳ 需修改 | 英文语言包 |
| 5 | `lang/zh_cn/questionnaire.php` | ⏳ 需创建 | 中文语言包(可选) |
| 6 | `templates/question_starrating.mustache` | ✅ 已创建 | 问题显示模板 |
| 7 | `templates/response_starrating.mustache` | ✅ 已创建 | 答案显示模板 |
| 8 | `styles_starrating.css` | ✅ 已创建 | CSS样式 |
| 9 | `javascript/starrating.js` | ✅ 已创建 | JavaScript脚本 |
| 10 | `db/install.php` | ⏳ 需修改 | 数据库安装 |
| 11 | `tests/behat/behat_mod_questionnaire.php` | ⏳ 需修改 | 测试配置 |

## 常见问题

### Q1: 星星不显示?
**A**: 确保Moodle加载了Font Awesome图标库。检查浏览器控制台是否有CSS加载错误。

### Q2: 点击星星没反应?
**A**: 检查JavaScript文件是否正确加载。打开浏览器控制台查看错误信息。

### Q3: 数据库错误?
**A**: 确保在 `questionnaire_question_type` 表中添加了类型记录。

### Q4: 找不到"Star Rating"选项?
**A**: 确保已清除缓存,并检查语言文件是否正确配置。

### Q5: 如何修改星星颜色?
**A**: 编辑 `styles_starrating.css` 文件,修改 `.star-selected` 的 `color` 属性。

## 技术支持

遇到问题时的检查清单:

- [ ] 所有文件都已创建/修改
- [ ] 数据库记录已添加
- [ ] 缓存已清除
- [ ] 浏览器控制台无错误
- [ ] PHP错误日志无异常
- [ ] 在测试环境先验证

## 下一步优化建议

1. ✨ 添加半星评分支持
2. 🎨 自定义星星颜色和大小
3. 📊 增强数据统计和报表功能
4. 📱 优化移动端触摸体验
5. 🌍 添加更多语言支持
6. ♿ 增强无障碍访问支持

## 版权信息

此实现遵循 GNU GPL v3 或更高版本许可证。

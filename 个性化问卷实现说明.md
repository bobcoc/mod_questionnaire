# Questionnaire个性化问卷调查功能实现总结

## 实现概述

本次实现为Moodle的Questionnaire模块添加了个性化附件功能,使得每个学生在填写问卷时只能看到以自己学号命名的附件。这特别适用于个人照片投票、隐私性资料审核等场景。

## 核心功能

1. **个性化附件管理**: 教师可以批量上传以学号命名的附件
2. **精准匹配**: 系统自动根据学号匹配学生和附件
3. **隐私保护**: 学生只能查看自己的附件,无法访问他人的
4. **灵活配置**: 问卷级别的开关控制是否启用个性化附件

## 技术实现细节

### 1. 数据库扩展

#### 新增表: questionnaire_personal_file
```sql
- id: 主键
- questionnaireid: 问卷ID(外键)
- userid: 用户ID(外键)
- idnumber: 学号
- filearea: 文件区域('personalfile')
- itemid: 文件项ID
- filename: 原始文件名
- timecreated: 创建时间
- timemodified: 修改时间
```

#### 扩展questionnaire表
新增字段: `personalfileenabled` (int) - 是否启用个性化附件功能

### 2. 核心文件修改

#### db/install.xml
- 添加questionnaire_personal_file表定义
- 为questionnaire表添加personalfileenabled字段

#### db/upgrade.php
- 版本号更新为2025103100
- 添加数据库升级逻辑,创建新表和字段

#### version.php
- 更新版本号为2025103100

#### mod_form.php
- 添加"Enable personalized files"复选框
- 包含帮助按钮和说明文本

#### questionnaire.class.php
新增方法:
- `get_personal_file($userid)`: 获取指定用户的个性化附件记录
- `get_personal_file_url($userid)`: 获取附件的可访问URL

#### lib.php
新增函数:
- `questionnaire_pluginfile()`: 处理个性化附件的文件服务
  - 权限检查:只有文件所有者或管理员可访问
  - 安全验证:防止跨用户访问

#### personalfiles.php (新建)
个性化附件管理页面,包含:
- 批量文件上传功能
- 文件列表显示
- 删除文件功能
- 学号自动匹配
- 错误提示和成功反馈

#### complete.php
- 在问卷显示前检查个性化附件
- 如果存在,则在页面中显示附件
- 如果不存在,显示提示信息

#### tabs.php
- 为启用个性化附件的问卷添加"Manage personalized files"标签页

### 3. 模板文件修改

#### templates/completepage.mustache
- 添加{{#personalfile}}模板占位符
- 在问卷内容前显示个性化附件

### 4. 语言文件扩展

#### lang/en/questionnaire.php
新增语言字符串:
- personalfileenabled - 功能开关标签
- personalfileenabled_help - 帮助文本
- personalfile_upload - 上传标题
- personalfile_uploadhelp - 上传说明
- personalfile_imported - 导入成功消息
- personalfile_usernotfound - 用户未找到错误
- personalfile_usernotenrolled - 用户未注册错误
- personalfile_deleted - 删除成功消息
- personalfile_existing - 现有文件标题
- personalfile_nofiles - 无文件提示
- personalfile_manage - 管理链接文本
- personalfile_yourfile - 您的文件标题
- personalfile_notfound - 文件未找到提示
- filename - 文件名
- timeuploaded - 上传时间

## 工作流程

### 教师端工作流程

1. **启用功能**
   - 编辑问卷设置
   - 勾选"Enable personalized files"
   - 保存设置

2. **准备文件**
   - 收集学生的个性化附件
   - 按学号重命名文件(如: 20231001.jpg)

3. **批量上传**
   - 进入"Manage personalized files"页面
   - 选择所有文件
   - 点击上传

4. **系统处理**
   - 解析文件名获取学号
   - 在数据库中查找匹配的用户
   - 验证用户是否在课程中注册
   - 保存文件到Moodle文件系统
   - 记录文件信息到数据库

5. **管理维护**
   - 查看已上传文件列表
   - 删除或更新文件
   - 监控上传状态

### 学生端工作流程

1. **访问问卷**
   - 学生点击问卷活动

2. **系统检查**
   - 检查问卷是否启用个性化附件
   - 根据学生ID查找对应附件

3. **显示附件**
   - 如果找到附件,在问卷顶部显示图片
   - 如果未找到,显示提示信息

4. **填写问卷**
   - 学生查看自己的附件
   - 根据附件内容填写问卷答案
   - 提交问卷

## 安全性考虑

### 权限控制
1. **上传权限**: 需要`mod/questionnaire:manage`权限
2. **查看权限**: 
   - 学生只能查看自己的附件
   - 教师和管理员可以查看所有附件
3. **文件服务**: 通过`questionnaire_pluginfile()`严格验证访问权限

### 数据验证
1. **学号匹配**: 严格匹配用户的idnumber字段
2. **课程注册**: 验证用户是否在课程中注册
3. **文件类型**: 限制为图片类型
4. **文件大小**: 遵循课程的最大文件大小限制

### 隐私保护
1. **文件隔离**: 每个学生只能访问自己的文件
2. **URL安全**: 使用itemid作为文件标识,防止遍历攻击
3. **会话验证**: 所有操作需要sesskey验证

## 使用场景

### 1. 个人照片审核
学生需要对自己提交的证件照片进行确认:
- 教师批量上传所有学生照片
- 每个学生只看到自己的照片
- 学生确认照片是否符合要求

### 2. 作品自我评价
学生对自己的作品进行评价:
- 教师上传每个学生的作品图片
- 学生看到自己的作品
- 填写自我评价问卷

### 3. 隐私性调查
涉及个人隐私的内容:
- 每个人看到不同的个性化内容
- 确保信息隐私和安全
- 收集针对性的反馈

## 已知限制

1. **文件命名**: 必须严格使用学号命名,不能有误差
2. **学号要求**: 用户必须设置idnumber字段
3. **文件类型**: 当前主要支持图片类型
4. **批量限制**: 一次上传文件数量受Moodle配置限制(默认50个)

## 扩展建议

### 短期优化
1. 支持更多文件类型(PDF、视频等)
2. 添加文件预览功能
3. 提供CSV批量导入文件映射
4. 添加附件上传进度条

### 长期规划
1. 支持多个附件关联到一个学生
2. 附件分组管理
3. 附件版本控制
4. 导出附件管理报告
5. 与学生信息系统集成

## 测试建议

### 功能测试
1. 上传功能测试
   - 正确命名的文件
   - 错误命名的文件
   - 超大文件
   - 不支持的文件类型

2. 显示功能测试
   - 有附件的学生
   - 无附件的学生
   - 不同浏览器兼容性
   - 移动设备显示

3. 权限测试
   - 学生访问自己的附件
   - 学生尝试访问他人附件
   - 教师管理附件
   - 游客访问限制

### 性能测试
1. 大量文件上传性能
2. 并发访问性能
3. 文件服务响应时间
4. 数据库查询效率

## 维护指南

### 日常维护
1. 定期检查上传失败的文件
2. 清理孤立的文件记录
3. 监控存储空间使用

### 故障排查
1. **学生看不到附件**
   - 检查文件是否上传成功
   - 验证文件名与学号是否匹配
   - 确认学生是否在课程中注册

2. **上传失败**
   - 检查文件大小限制
   - 验证文件格式
   - 查看服务器错误日志

3. **权限问题**
   - 验证用户角色和权限
   - 检查课程设置
   - 确认模块安装正确

## 总结

本次实现成功为Questionnaire模块添加了个性化附件功能,实现了以下目标:

✅ 支持批量上传以学号命名的附件  
✅ 学生只能看到自己的附件  
✅ 教师可以方便地管理所有附件  
✅ 完善的权限控制和安全保护  
✅ 友好的用户界面和操作体验  
✅ 清晰的文档和使用指南  

该功能已经可以投入实际使用,满足个人照片投票、隐私性问卷调查等应用场景的需求。

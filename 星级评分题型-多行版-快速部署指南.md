# 星级评分题型 - 多行评分版 - 快速部署指南

## ⚡ 重要更新

**新版本特性**: 基于Rate(评分量表)题型,支持**多行星级评分**!

就像您提供的图片那样:
- ✅ 可以有多个评分维度
- ✅ 每行独立评分
- ✅ 例如:"知识建构"下有4个评分项,每项都可以独立打1-5星

## 🔑 关键步骤:在数据库添加题型记录

### ⚠️ 重要提醒

如果您之前已经按照旧指南添加过题型记录,**必须先删除旧记录**:

```sql
-- 删除旧记录(如果存在)
DELETE FROM mdl_questionnaire_question_type WHERE typeid = 12;
```

### 添加新题型记录

```sql
-- 插入新的星级评分题型(基于Rate)
INSERT INTO mdl_questionnaire_question_type (typeid, type, has_choices, response_table) 
VALUES (12, 'Star Rating', 'y', 'response_rank');
```

**关键配置说明**:
- `typeid = 12` - 题型ID
- `type = 'Star Rating'` - 题型名称
- `has_choices = 'y'` - **必须是'y'**(支持多个选项)
- `response_table = 'response_rank'` - 使用rank表存储(与Rate相同)

### 验证数据

```sql
SELECT * FROM mdl_questionnaire_question_type WHERE typeid = 12;
```

应该看到:
```
typeid | type         | has_choices | response_table
12     | Star Rating  | y           | response_rank
```

## 📋 已完成的修改

✅ 所有文件已重新修改,基于Rate题型:

1. ✅ `classes/question/starrating.php` - 基于Rate,支持多行评分
2. ✅ `classes/question/question.php` - 常量定义
3. ✅ `locallib.php` - 类型名称映射
4. ✅ `lang/en/questionnaire.php` - 语言字符串
5. ✅ `db/install.php` - 安装脚本(已更新为response_rank)
6. ✅ `templates/question_starrating.mustache` - 多行星级评分模板
7. ✅ `templates/response_starrating.mustache` - 多行答案显示模板
8. ✅ `styles_starrating.css` - 样式文件
9. ✅ `tests/behat/behat_mod_questionnaire.php` - 测试配置

## 🚀 完整部署步骤

### 1. 更新数据库(最关键!)

如果之前添加过,先删除:
```sql
DELETE FROM mdl_questionnaire_question_type WHERE typeid = 12;
```

然后添加新的:
```sql
INSERT INTO mdl_questionnaire_question_type (typeid, type, has_choices, response_table) 
VALUES (12, 'Star Rating', 'y', 'response_rank');
```

或者使用提供的SQL文件: `添加星级评分题型到数据库.sql`

### 2. 清除Moodle缓存

```bash
# 方式1: 通过管理界面
网站管理 > 开发 > 清除所有缓存

# 方式2: 通过命令行
php admin/cli/purge_caches.php
```

### 3. 测试新题型

1. 进入任意课程
2. 添加问卷活动
3. 编辑问题
4. 选择 **"Star Rating"** 题型
5. 配置问题:
   - **Question Name**: Q1
   - **Question Text**: 知识建构
   - **Maximum number of stars**: 5
   - **Possible answers**(每行一个评分项):
     ```
     能否使用电子表格完成聚类过程。
     能否用 Python 程序完成聚类过程。
     能否认识到初始质心对聚类结果有影响。
     能否理解选择合适K值的重要性。
     ```
6. 保存并测试

## 🎯 效果预览

创建后学生看到的界面:

```
知识建构 *

能否使用电子表格完成聚类过程。
☆☆☆☆☆ (0/5)

能否用 Python 程序完成聚类过程。
☆☆☆☆☆ (0/5)

能否认识到初始质心对聚类结果有影响。
☆☆☆☆☆ (0/5)

能否理解选择合适K值的重要性。
☆☆☆☆☆ (0/5)
```

学生点击后:
```
能否使用电子表格完成聚类过程。
★★★★☆ (4/5)

能否用 Python 程序完成聚类过程。
★★★★★ (5/5)

能否认识到初始质心对聚类结果有影响。
★★★☆☆ (3/5)

能否理解选择合适K值的重要性。
★★★★☆ (4/5)
```

## 💡 核心特性

- ⭐ **多行评分**: 像Rate题型一样,支持多个评分维度
- 🎨 **精美样式**: 仿淘宝星级样式
- 📊 **独立评分**: 每行独立打分,互不影响
- 💾 **数据兼容**: 使用response_rank表,与Rate相同
- 🔄 **可取消**: 点击相同星星可取消评分
- 📱 **响应式**: 支持移动端

## 🔄 与Rate题型的区别

| 特性 | Rate (1..5) | Star Rating |
|------|-------------|-------------|
| 显示方式 | 单选按钮/表格 | 星星图标 |
| 交互方式 | 点击单选 | 点击星星 |
| 视觉效果 | 表格布局 | 星级图标 |
| 数据表 | response_rank | response_rank |
| 多行支持 | ✅ | ✅ |
| 适用场景 | 评分量表 | 星级评价 |

## 📊 数据存储

- **存储表**: `mdl_questionnaire_response_rank`
- **字段结构**:
  - `response_id`: 响应ID
  - `question_id`: 问题ID
  - `choice_id`: 选项ID(每个评分项)
  - `rankvalue`: 星级值(1-最大星数)

## 🐛 故障排查

### 问题1: 看不到"Star Rating"选项

**解决**:
1. 确认数据库记录正确(`has_choices='y'`, `response_table='response_rank'`)
2. 清除所有缓存
3. 刷新浏览器

### 问题2: 无法添加"Possible answers"

**原因**: 题型配置错误,has_choices应该为'y'

**解决**: 
1. 检查数据库记录
2. 删除旧记录,重新插入正确配置

### 问题3: 数据无法保存

**原因**: response_table配置错误

**解决**: 
确保数据库中`response_table = 'response_rank'`

### 问题4: 星星不显示或无法点击

**解决**: 
1. 检查浏览器控制台错误
2. 确保Font Awesome已加载
3. 清除浏览器缓存

## ✅ 部署检查清单

- [ ] 数据库记录已正确添加 (`has_choices='y'`, `response_table='response_rank'`)
- [ ] 清除了所有Moodle缓存
- [ ] 刷新了浏览器
- [ ] 能在题型列表看到"Star Rating"
- [ ] 能添加"Possible answers"(多行评分项)
- [ ] 星星能正常显示和点击
- [ ] 每行可以独立评分
- [ ] 数据能正常保存
- [ ] 查看答案时显示正确

## 📝 使用示例

### 示例1: 课程评价

**Question Text**: 请对本课程进行评价

**Possible answers**:
```
课程内容质量
教师授课水平
课程资源丰富度
作业难度合理性
整体满意度
```

### 示例2: 能力自评(如您的图片)

**Question Text**: 知识建构

**Possible answers**:
```
能否使用电子表格完成聚类过程。
能否用 Python 程序完成聚类过程。
能否认识到初始质心对聚类结果有影响。
能否理解选择合适K值的重要性。
```

### 示例3: 服务评价

**Question Text**: 请对以下服务进行评分

**Possible answers**:
```
商品质量
物流速度
客服态度
包装质量
```

## 🎉 完成!

现在您的星级评分题型已经支持多行评分了!

就像您提供的图片那样,可以:
1. 创建分组评分(如"知识建构"、"课堂投入"、"合作水平")
2. 每组下有多个评分项
3. 学生可以对每项独立打星
4. 数据独立保存和统计

## 🆚 新旧版本对比

| 功能 | 旧版本(基于Slider) | 新版本(基于Rate) |
|------|-------------------|------------------|
| 评分维度 | 单一 | **多个** ✅ |
| 评分项数量 | 1个 | **不限** ✅ |
| 适用场景 | 单项评分 | **多维度评价** ✅ |
| 数据表 | response_text | response_rank |
| 是否需要choices | 否 | **是** |

## 需要帮助?

如果遇到问题:
1. 检查数据库配置是否正确
2. 确认has_choices='y'
3. 确认response_table='response_rank'
4. 查看浏览器控制台错误
5. 清除缓存后重试

